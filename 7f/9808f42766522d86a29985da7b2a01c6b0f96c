Return-Path: <caml-list-owner@inria.fr>
Authentication-Results: plum.tunbury.org;
	dkim=pass (1024-bit key; unprotected) header.d=inria.fr header.i=@inria.fr header.a=rsa-sha256 header.s=dc header.b=aQV0kv67;
	dkim=pass (2048-bit key; unprotected) header.d=college-de-france.fr header.i=@college-de-france.fr header.a=rsa-sha256 header.s=05BE819C-8883-4F62-9828-EF4D49272C46 header.b=FvU1fuyG;
	dkim-atps=neutral
Received-SPF: Pass (mailfrom) identity=mailfrom; client-ip=192.134.164.83; helo=mail2-relais-roc.national.inria.fr; envelope-from=caml-list-owner@inria.fr; receiver=tunbury.org 
Received: from mail2-relais-roc.national.inria.fr (mail2-relais-roc.national.inria.fr [192.134.164.83])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by plum.tunbury.org (Postfix) with ESMTPS id 6910E417D0
	for <caml-list@tunbury.org>; Thu, 12 Dec 2024 17:31:59 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
  d=inria.fr; s=dc;
  h=mime-version:references:in-reply-to:from:date:message-id:
   to:cc:subject:reply-to:sender:list-id:list-help:
   list-subscribe:list-unsubscribe:list-post:list-owner:
   list-archive;
  bh=tO19T+ilw75mGyCzDc+1Weke9CrirGjCEeaMooJJIF0=;
  b=aQV0kv67pbKvixgC9XOnPvDGSxalC51rX5A4x3jQ1JOyUL3QYhVyKUPc
   evzt56mav3RwkAC9w6HXroDzUfKHGPvpWwm96QjvSETnlaMhYq+MhYgre
   cVD0pj9gxYyEMFtutZRBdS8Tpo/S27kPhOppPpEwBkllWgUM/5IeWq3+o
   o=;
Received-SPF: Pass (mail2-relais-roc.national.inria.fr: domain of
  caml-list-owner@inria.fr designates 128.93.162.160 as
  permitted sender) identity=mailfrom;
  client-ip=128.93.162.160;
  receiver=mail2-relais-roc.national.inria.fr;
  envelope-from="caml-list-owner@inria.fr";
  x-sender="caml-list-owner@inria.fr"; x-conformance=spf_only;
  x-record-type="v=spf1"; x-record-text="v=spf1
  include:mailout.safebrands.com a:basic-mail.safebrands.com
  a:basic-mail01.safebrands.com a:basic-mail02.safebrands.com
  ip4:128.93.142.0/24 ip4:192.134.164.0/24 ip4:128.93.162.160
  ip4:128.93.162.3 ip4:128.93.162.88 ip4:89.107.174.7 mx ~all"
Received-SPF: None (mail2-relais-roc.national.inria.fr: no sender
  authenticity information available from domain of
  postmaster@sympa.inria.fr) identity=helo;
  client-ip=128.93.162.160;
  receiver=mail2-relais-roc.national.inria.fr;
  envelope-from="caml-list-owner@inria.fr";
  x-sender="postmaster@sympa.inria.fr"; x-conformance=spf_only
Authentication-Results: mail2-relais-roc.national.inria.fr; spf=Pass smtp.mailfrom=caml-list-owner@inria.fr; spf=None smtp.helo=postmaster@sympa.inria.fr; dkim=pass (signature verified) header.i=@college-de-france.fr
X-IronPort-AV: E=Sophos;i="6.12,229,1728943200"; 
   d="scan'208,217";a="198892240"
Received: from prod-listesu18.inria.fr (HELO sympa.inria.fr) ([128.93.162.160])
  by mail2-relais-roc.national.inria.fr with ESMTP; 12 Dec 2024 18:31:58 +0100
Received: by sympa.inria.fr (Postfix, from userid 20132)
	id AA597E0077; Thu, 12 Dec 2024 18:31:58 +0100 (CET)
Received: from mail3-relais-sop.national.inria.fr (mail3-relais-sop.national.inria.fr [192.134.164.104])
	by sympa.inria.fr (Postfix) with ESMTPS id 4437BE0077
	for <caml-list@sympa.inria.fr>; Thu, 12 Dec 2024 18:31:52 +0100 (CET)
IronPort-SDR: 675b1e07_gGH9N7tOfhiiBTYby1UMzTBaK9Q5ZjzEqBVoPNSNB0rMZMb
 RGVXGm0hU2yRv7yrG+fXxPuTTmJ8PUYhJYH0dbA==
X-IronPort-AV: E=Sophos;i="6.12,229,1728943200"; 
   d="scan'208,217";a="104189938"
X-MGA-submission: =?us-ascii?q?MDGVlvvdak78JanHrY4gIWRnpRUqzYPJVHdaG5?=
 =?us-ascii?q?jqhp7dEuv/uBF64xxHR0nIjan+3zAOLwgjmryljwlB6dxGxGvauQvhm9?=
 =?us-ascii?q?FSZNyyVb8BQoM1Rr0gl+y72vAMH82+7VujAUjJIUhzFXBvr+JsYr0Ica?=
 =?us-ascii?q?igATwJPsR+nAuNXnAQdSYBvw=3D=3D?=
Received: from smtpout02-ext4.partage.renater.fr ([194.254.241.31])
  by mail3-smtp-sop.national.inria.fr with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Dec 2024 18:31:53 +0100
Received: from zmtaauth04.partage.renater.fr (zmtaauth04.partage.renater.fr [194.254.241.26])
	by smtpout20.partage.renater.fr (Postfix) with ESMTP id A54B3BFC9E
	for <caml-list@inria.fr>; Thu, 12 Dec 2024 18:31:50 +0100 (CET)
Received: from zmtaauth04.partage.renater.fr (localhost [127.0.0.1])
	by zmtaauth04.partage.renater.fr (Postfix) with ESMTPS id 9DA7D1C030D
	for <caml-list@inria.fr>; Thu, 12 Dec 2024 18:31:50 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by zmtaauth04.partage.renater.fr (Postfix) with ESMTP id 8D6741C0338
	for <caml-list@inria.fr>; Thu, 12 Dec 2024 18:31:50 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.10.3 zmtaauth04.partage.renater.fr 8D6741C0338
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=college-de-france.fr; s=05BE819C-8883-4F62-9828-EF4D49272C46;
	t=1734024710; bh=tO19T+ilw75mGyCzDc+1Weke9CrirGjCEeaMooJJIF0=;
	h=MIME-Version:From:Date:Message-ID:To;
	b=FvU1fuyGIcMflOl//5y+dv4d6muh2mDKlrN6gS4lxTilU7+tdvUfP+LuoXPYAZscZ
	 Fc3/TvGCnXkcXrMg/iITUE+a52CCBHQI6Ryt1JUwGFQ2VZbs0SixP6kPRkWB7nvBVP
	 74LgBswHrKXR4Rp1kABpCyAAeHrzmFkssTSs7fJUeyDi5IybQECnebra48FiQOcwue
	 Kun8woRzuYhgbDFZNZ7hXhnlHebxGyOmjLlVFvTwmSkY7Neu6/UOpgfNo7ubd6mjZb
	 dyY3skRImYnRLWrdFVspsWL1UuvrmtY+h3CJSedxfVAD85x8HY2IdBoBbvaAyMiSrF
	 qlcrcqo8b58Jw==
Received: from zmtaauth04.partage.renater.fr ([127.0.0.1])
 by localhost (zmtaauth04.partage.renater.fr [127.0.0.1]) (amavis, port 10026)
 with ESMTP id 0OG2o_993JZx for <caml-list@inria.fr>;
 Thu, 12 Dec 2024 18:31:50 +0100 (CET)
Received: from 209.85.222.178 (unknown [194.254.241.249])
	by zmtaauth04.partage.renater.fr (Postfix) with ESMTPA id 5AA8F1C030D
	for <caml-list@inria.fr>; Thu, 12 Dec 2024 18:31:50 +0100 (CET)
Received: by mail-qk1-f178.google.com with SMTP id af79cd13be357-7b6f1be1daeso71202785a.0
        for <caml-list@inria.fr>; Thu, 12 Dec 2024 09:31:50 -0800 (PST)
X-Gm-Message-State: AOJu0YwWi/cAlOFjMAu8ivW0eRNamUmV2j546jjF8gOvjKKc4tIwwQgN
	OPRIdhTH3tU/9fndGKQzj0us5ja5EJi5qFeW5eJs9B9QJP+WDPUyx9Dn2rl19L3Qu87SEkYd4cQ
	07+xO7HJZ427NbRDwLQn1nTwIn5o=
X-Google-Smtp-Source: AGHT+IHn5bakere+URJ1zx9Kf+4kMSq+B/T+9dLVnbA4WHM3q7EO1zY44ZGSum/GL9PRVFgLfpHM1PTZMEo0wlHUs6s=
X-Received: by 2002:a05:620a:3904:b0:7b6:cf4d:c43c with SMTP id
 af79cd13be357-7b6f89f43ecmr210672585a.55.1734024709393; Thu, 12 Dec 2024
 09:31:49 -0800 (PST)
MIME-Version: 1.0
References: <D5CAD9C8-4AD2-44FA-87FF-A04B03E04ACB@mpi-sws.org>
 <CWLP265MB415788DB633E5044F294FB8EBC342@CWLP265MB4157.GBRP265.PROD.OUTLOOK.COM>
 <CAC=54B+DN2RKYMfM=R9YrpTkZZ=6i4K40WAp=HcLpZNT3+9V6Q@mail.gmail.com> <FD2626D6-366B-4C5C-A771-1212436346CF@mpi-sws.org>
In-Reply-To: <FD2626D6-366B-4C5C-A771-1212436346CF@mpi-sws.org>
From: Xavier Leroy <xavier.leroy@college-de-france.fr>
Date: Thu, 12 Dec 2024 18:31:22 +0100
X-Gmail-Original-Message-ID: <CAH=h3gH2MoAy+TMO-dUOnK8+tPc38T8OHFFkxPHVA6EExN9B8Q@mail.gmail.com>
Message-ID: <CAH=h3gH2MoAy+TMO-dUOnK8+tPc38T8OHFFkxPHVA6EExN9B8Q@mail.gmail.com>
To: Andreas Rossberg <rossberg@mpi-sws.org>
Cc: "caml-list@inria.fr" <caml-list@inria.fr>
Content-Type: multipart/alternative; boundary="000000000000d5e33606291616ed"
X-Virus-Scanned: clamav-milter 0.103.8 at clamav01
X-Virus-Status: Clean
X-Renater-Ptge-SpamState: clean
X-Renater-Ptge-SpamScore: -100
X-Renater-Ptge-SpamCause: gggruggvucftvghtrhhoucdtuddrgeefuddrkeehgddutddtucetufdoteggodetrfdotffvucfrrhhofhhilhgvmecutffgpfetvffgtfenuceurghilhhouhhtmecufedttdenucesvcftvggtihhpihgvnhhtshculddquddttddmnecujfgurhepgghfjgfhfffkuffvvegtsegrtderredttdejnecuhfhrohhmpegirghvihgvrhcunfgvrhhohicuoeigrghvihgvrhdrlhgvrhhohiestgholhhlvghgvgdquggvqdhfrhgrnhgtvgdrfhhrqeenucggtffrrghtthgvrhhnpeehteehfeevffffueffudfgieeggeetkeeifeegjeeivedutddtfeefueffuedtvdenucffohhmrghinhepghhithhhuhgsrdgtohhmpdgtohhnfhhighhurhgvrdgrtgenucfkphepudelgedrvdehgedrvdeguddrvdegleenucevlhhushhtvghrufhiiigvpedtnecurfgrrhgrmhepihhnvghtpeduleegrddvheegrddvgedurddvgeelpdhhvghlohepvddtledrkeehrddvvddvrddujeekpdhmrghilhhfrhhomhepgigrvhhivghrrdhlvghrohihsegtohhllhgvghgvqdguvgdqfhhrrghntggvrdhfrhdpnhgspghrtghpthhtohepuddprhgtphhtthhopegtrghmlhdqlhhishhtsehinhhrihgrrdhfrh
Subject: Re: [Caml-list] Static linking with Mingw and dune
Reply-To: Xavier Leroy <xavier.leroy@college-de-france.fr>
X-Loop: caml-list@inria.fr
X-Sequence: 19229
Errors-To: caml-list-owner@inria.fr
Precedence: list
Precedence: bulk
Sender: caml-list-request@inria.fr
X-no-archive: yes
List-Id: <caml-list.inria.fr>
List-Help: <mailto:sympa_inria@inria.fr?subject=help>
List-Subscribe: <mailto:sympa_inria@inria.fr?subject=subscribe%20caml-list>
List-Unsubscribe: <mailto:sympa_inria@inria.fr?subject=unsubscribe%20caml-list>
List-Post: <mailto:caml-list@inria.fr>
List-Owner: <mailto:caml-list-request@inria.fr>
List-Archive: <https://sympa.inria.fr/sympa/arc/caml-list>
Archived-At: <https://sympa.inria.fr/sympa/arcsearch_id/caml-list/2024-12/CAH%3Dh3gH2MoAy%2BTMO-dUOnK8%2BtPc38T8OHFFkxPHVA6EExN9B8Q%40mail.gmail.com>

--000000000000d5e33606291616ed
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

On Thu, Dec 12, 2024 at 8:46=E2=80=AFAM Andreas Rossberg <rossberg@mpi-sws.=
org>
wrote:

> Good to know, thank you for the suggestions!
>
> However, I=E2=80=99m afraid that hacking the compiler and tool chain for =
this
> purpose is not an option =E2=80=94 that would require everybody else who =
wants to
> build the project to do the same, which is infeasible.
>
> It=E2=80=99s a bit disappointing that there seems to be no easy solution =
for this
> problem. I would expect it to be a common pain point for folks using OCam=
l
> 5 to develop and publish application binaries for Windows. Or am I just
> alien?
>

OCaml's dependency on winpthreads will probably go away in the near future,
see https://github.com/ocaml/ocaml/pull/13416 .

But, more generally, static linking of C libraries is getting more and more
difficult -- even from C, not just OCaml.  For example, under Linux, it's
essentially impossible to statically link with the glibc C standard
library; a musl-based distribution must be used if static linking is
desired.  It looks as if the consensus was that static linking of libraries
is a bad idea and must be prevented.  I don't think it is, but that's
something way beyond OCaml's control.

Best,

- Xavier Leroy




>
> Cheers,
> /Andreas
>
>
> > On 2. Dec 2024, at 09:25, Antonin D=C3=A9cimo <antonin.decimo@gmail.com=
>
> wrote:
> >
> >> Regarding OCaml 5.3/mingw64 you shouldn't need to have to do anything
> with libwinpthreads because it's only used for the msvc port, not the min=
gw
> one.
> >
> > That is not quite exact, winpthreads is used with mingw-w64, but found
> > in the system installation, and linked to. It is vendored for the MSVC
> > port and we *statically* link into the runtime only the parts we're
> > interested in.
> >
> > To statically link with winpthreads, I suggest you do all of it manuall=
y:
> > - clone winpthreads sources at https://github.com/mingw-w64/mingw-w64,
> > go to mingw-w64-libraries/winpthreads, and build a static version of
> > the library with your preferred toolchain;
> >
> > - hack the OCaml compiler / Makefile to *not* use `-lpthreads`:
> >
> https://github.com/ocaml/ocaml/blob/5a5eb481c7a9d0f039e3169aa8ed19c9b926e=
982/configure.ac#L2372-L2373
> >  Maybe it's just sufficient to set PTHREAD_LIBS when invoking
> > configure; however seeing this line makes me think that winpthreads is
> > already statically linked with the runtime.
> >
> >     PTHREAD_LIBS=3D"-l:libpthread.a $link_gcc_eh"]
> >
> >  Haven't dug further.
> >
> > -- Antonin
>
>

--000000000000d5e33606291616ed
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr"><div class=3D"gmail_quote gmail_quote_container"><div dir=
=3D"ltr" class=3D"gmail_attr">On Thu, Dec 12, 2024 at 8:46=E2=80=AFAM Andre=
as Rossberg &lt;<a href=3D"mailto:rossberg@mpi-sws.org">rossberg@mpi-sws.or=
g</a>&gt; wrote:<br></div><blockquote class=3D"gmail_quote" style=3D"margin=
:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"=
>Good to know, thank you for the suggestions!<br>
<br>
However, I=E2=80=99m afraid that hacking the compiler and tool chain for th=
is purpose is not an option =E2=80=94 that would require everybody else who=
 wants to build the project to do the same, which is infeasible.<br>
<br>
It=E2=80=99s a bit disappointing that there seems to be no easy solution fo=
r this problem. I would expect it to be a common pain point for folks using=
 OCaml 5 to develop and publish application binaries for Windows. Or am I j=
ust alien?<br></blockquote><div><br></div><div><div style=3D"font-family:ar=
ial,sans-serif;font-size:large" class=3D"gmail_default">OCaml&#39;s depende=
ncy on winpthreads will probably go away in the near future, see <a href=3D=
"https://github.com/ocaml/ocaml/pull/13416">https://github.com/ocaml/ocaml/=
pull/13416</a> .</div><div style=3D"font-family:arial,sans-serif;font-size:=
large" class=3D"gmail_default"><br></div><div style=3D"font-family:arial,sa=
ns-serif;font-size:large" class=3D"gmail_default">But, more generally, stat=
ic linking of C libraries is getting more and more difficult -- even from C=
, not just OCaml.=C2=A0 For example, under Linux, it&#39;s essentially impo=
ssible to statically link with the glibc C standard library; a musl-based d=
istribution must be used if static linking is desired.=C2=A0 It looks as if=
 the consensus was that static linking of libraries is a bad idea and must =
be prevented.=C2=A0 I don&#39;t think it is, but that&#39;s something way b=
eyond OCaml&#39;s control.</div><div style=3D"font-family:arial,sans-serif;=
font-size:large" class=3D"gmail_default"><br></div><div style=3D"font-famil=
y:arial,sans-serif;font-size:large" class=3D"gmail_default">Best,</div><div=
 style=3D"font-family:arial,sans-serif;font-size:large" class=3D"gmail_defa=
ult"><br></div><div style=3D"font-family:arial,sans-serif;font-size:large" =
class=3D"gmail_default">- Xavier Leroy</div><div style=3D"font-family:arial=
,sans-serif;font-size:large" class=3D"gmail_default"><br></div><br></div><d=
iv>=C2=A0</div><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0p=
x 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex">
<br>
Cheers,<br>
/Andreas<br>
<br>
<br>
&gt; On 2. Dec 2024, at 09:25, Antonin D=C3=A9cimo &lt;<a href=3D"mailto:an=
tonin.decimo@gmail.com" target=3D"_blank">antonin.decimo@gmail.com</a>&gt; =
wrote:<br>
&gt; <br>
&gt;&gt; Regarding OCaml 5.3/mingw64 you shouldn&#39;t need to have to do a=
nything with libwinpthreads because it&#39;s only used for the msvc port, n=
ot the mingw one.<br>
&gt; <br>
&gt; That is not quite exact, winpthreads is used with mingw-w64, but found=
<br>
&gt; in the system installation, and linked to. It is vendored for the MSVC=
<br>
&gt; port and we *statically* link into the runtime only the parts we&#39;r=
e<br>
&gt; interested in.<br>
&gt; <br>
&gt; To statically link with winpthreads, I suggest you do all of it manual=
ly:<br>
&gt; - clone winpthreads sources at <a href=3D"https://github.com/mingw-w64=
/mingw-w64" rel=3D"noreferrer" target=3D"_blank">https://github.com/mingw-w=
64/mingw-w64</a>,<br>
&gt; go to mingw-w64-libraries/winpthreads, and build a static version of<b=
r>
&gt; the library with your preferred toolchain;<br>
&gt; <br>
&gt; - hack the OCaml compiler / Makefile to *not* use `-lpthreads`:<br>
&gt;=C2=A0 <a href=3D"https://github.com/ocaml/ocaml/blob/5a5eb481c7a9d0f03=
9e3169aa8ed19c9b926e982/configure.ac#L2372-L2373" rel=3D"noreferrer" target=
=3D"_blank">https://github.com/ocaml/ocaml/blob/5a5eb481c7a9d0f039e3169aa8e=
d19c9b926e982/configure.ac#L2372-L2373</a><br>
&gt;=C2=A0 Maybe it&#39;s just sufficient to set PTHREAD_LIBS when invoking=
<br>
&gt; configure; however seeing this line makes me think that winpthreads is=
<br>
&gt; already statically linked with the runtime.<br>
&gt; <br>
&gt;=C2=A0 =C2=A0 =C2=A0PTHREAD_LIBS=3D&quot;-l:libpthread.a $link_gcc_eh&q=
uot;]<br>
&gt; <br>
&gt;=C2=A0 Haven&#39;t dug further.<br>
&gt; <br>
&gt; -- Antonin<br>
<br>
</blockquote></div></div>

--000000000000d5e33606291616ed--
